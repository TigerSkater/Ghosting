<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Squash Ghosting Drill</title>
  <style>
    body {
      background-color: teal;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      color: white;
      text-align: center;
      padding: 1em;
    }
    img {
      width: 200px;
      display: none;
      margin: 1em auto;
    }
    #countdown {
      font-size: 5em;
      margin: 0.5em;
    }
    #direction {
      font-size: 3em;
      margin: 0.5em;
    }
    input, button {
      padding: 0.5em;
      font-size: 1em;
      margin: 0.5em;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Squash Ghosting Drill</h1>
  <label>Number of Sets: <input id="sets" type="number" min="1" value="1"></label><br>
  <label>Moves per Set: <input id="moves" type="number" min="1" value="5"></label><br>
  <label>Reaction Time (s): <input id="reaction" type="number" min="0" value="2"></label><br>
  <label>Reposition Time (s): <input id="reposition" type="number" min="0" value="1"></label><br>
  <label>Rest Between Sets (s): <input id="rest" type="number" min="0" value="10"></label><br>
  <label><input type="checkbox" id="motivation"> Motivational messages</label><br>
  <button onclick="startDrill()">Start Drill</button>
  <div id="countdown"></div>
  <div id="direction"></div>
  <img id="directionImg" src="" alt="Direction image">

  <script>
    const directions = [
      { name: "Front Left", img: "images/front-left.png" },
      { name: "Front Right", img: "images/front-right.png" },
      { name: "Back Left", img: "images/back-left.png" },
      { name: "Back Right", img: "images/back-right.png" },
      { name: "Center", img: "images/center.png" }
    ];

    const motivationMessages = [
      "You're crushing it!",
      "Keep up the pace!",
      "Fast feet win games!",
      "Breathe and push!",
      "You're unstoppable!"
    ];

    function speak(text) {
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1.3;
      u.volume = 1;
      speechSynthesis.speak(u);
    }

    function pickRandom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function playBeep() {
      const beep = new Audio("audio/beep.mp3");
      beep.play();
    }

    function playMotivationMessage() {
      if (!motivationOn) return;

      const message = pickRandom(motivationMessages); // this is a string
      const audioPath = `audio/${message}.mp3`;
      const audio = new Audio(audioPath);

      let played = false;

      audio.addEventListener("canplaythrough", () => {
        audio.play();
        played = true;
      });

      audio.addEventListener("error", () => {
        if (!played) {
          speak(message);
        }
      });

      setTimeout(() => {
        if (!played) {
          speak(message);
        }
      }, 500);
    }

    let setCount, moveCount, maxSets, maxMoves, reactionTime, repositionTime, restTime, motivationOn;
    let countdownEl = document.getElementById("countdown");
    let directionEl = document.getElementById("direction");
    let imageEl = document.getElementById("directionImg");
    let stopped = false;

    function startDrill() {
      maxSets = parseInt(document.getElementById("sets").value);
      maxMoves = parseInt(document.getElementById("moves").value);
      reactionTime = parseFloat(document.getElementById("reaction").value);
      repositionTime = parseFloat(document.getElementById("reposition").value);
      restTime = parseFloat(document.getElementById("rest").value);
      motivationOn = document.getElementById("motivation").checked;

      if (
        isNaN(maxSets) || maxSets < 1 ||
        isNaN(maxMoves) || maxMoves < 1 ||
        isNaN(reactionTime) ||
        isNaN(repositionTime) ||
        isNaN(restTime)
      ) {
        alert("Please input a value for all fields. Use 0 if needed.");
        return;
      }

      setCount = 1;
      moveCount = 0;
      stopped = false;
      runMove();
    }

    function runMove() {
      if (stopped) return;

      if (moveCount >= maxMoves) {
        if (setCount >= maxSets) {
          countdownEl.textContent = "Workout Complete!";
          directionEl.textContent = "Great job!";
          imageEl.style.display = "none";
          return;
        } else {
          setCount++;
          moveCount = 0;
          countdownEl.textContent = `Rest: ${restTime}s`;
          setTimeout(runMove, restTime * 1000);
          return;
        }
      }

      const move = pickRandom(directions);
      directionEl.style.display = "block";
      imageEl.style.display = "block";
      directionEl.textContent = move.name;
      imageEl.src = move.img;
      countdownEl.textContent = "";
      playBeep();

      setTimeout(() => {
        speechSynthesis.cancel();
        speak(move.name);
      }, 100);

      moveCount++;

      let countdown = reactionTime;
      countdownEl.textContent = countdown;

      const countdownInterval = setInterval(() => {
        if (stopped) {
          clearInterval(countdownInterval);
          return;
        }

        countdown--;
        countdownEl.textContent = countdown >= 0 ? countdown : "";

        if (countdown >= 0) {
          playBeep();
        }

        if (countdown < 0) {
          clearInterval(countdownInterval);

          if (motivationOn) {
            playMotivationMessage();
            setTimeout(() => { if (!stopped) runMove(); }, 3000);
          } else {
            playBeep();
            setTimeout(() => { if (!stopped) runMove(); }, repositionTime * 1000);
          }
        }
      }, 1000);
    }
  </script>
</body>
</html>
